version: "3"
services:
  # OpenLineage API (Our App)
  api:
    build: .
    ports:
      - "8080:8080"
    environment:
      - MONGODB_HOST=mongo
    depends_on:
      - mongo

  # MongoDB Storage
  mongo:
    image: mongo:6.0
    ports:
      - "27017:27017" # Exposed to host for inspection if needed
    volumes:
      - mongo_data:/data/db

  # Marquez Web UI
  web:
    image: marquezproject/marquez-web:latest
    ports:
      - "3000:3000"
    environment:
      # Marquez Web usually defaults to /api/v1 for backend. Only needs override if different host/port.
      # Default nginx config in the container proxies /api/v1 to 5000. 
      # We need to make sure the web container can talk to our 'api' container on port 5000.
      - MARQUEZ_HOST=api
      - WEB_PORT=3000
      - API_PORT=8080
      - MARQUEZ_PORT=8080

      # NOTE: MARQUEZ_PORT here refers to the internal port of the API container if using internal networking (api:5000)
      # However, if the web UI is client-side (SPA) talking to API, it typically needs the public URL.
      # But Marquez Web usually proxies via Nginx sidecar or internal. 
      # Let's assume standard Marquez Web setup: it proxies locally to upstream.
      # Wait, Marquez Web container usually serves the frontend which makes browser calls to ...?
      # Actually, Marquez Web is a React app. It likely needs to know where the API is ACCESSIBLE FROM THE BROWSER.
      # If so, we need to point it to localhost:5002.
      # Let's check common Marquez Web env vars. 
      # It often uses MARQUEZ_HOST and MARQUEZ_PORT to generate the base URL or proxy pass.
      # If it's a proxy pass inside nginx in the container, it's `api:5000` (internal).
      # If it injects env vars into the React app, it's `localhost:5002`.
      # Given the error was host port bind failure, internal 5000 is fine.
      # BUT, if we changed host port to 5002, and the UI talks to API via browser, we might need to config that.
      # Standard Marquez Web image (marquezproject/marquez-web) typically uses nginx to proxy /api to the backend.
      # So MARQUEZ_HOST=api and MARQUEZ_PORT=5000 (internal) should still work for the proxy!
      # The browser talks to Web UI on 3000, and Web UI proxies /api to backend:5000.
      # usage: 3000 -> nginx -> api:5000
      # So NO CHANGE needed here IF it uses proxying.
      # However, to be safe, I will not change this logic unless the user reports UI issues.
      # The error was purely "bind: address already in use" for port 5000 on HOST.
      # Changing host port mapping 5002:5000 fixes the bind error.
      # The internal communication api:5000 remains valid.


volumes:
  mongo_data:
